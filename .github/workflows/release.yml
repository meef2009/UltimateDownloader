name: build-release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build-release:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller requests customtkinter

      - name: Install Inno Setup
        run: |
          choco install innosetup --yes

      - name: Extract version from tag
        id: ver
        shell: pwsh
        run: |
          $tag = "${env:GITHUB_REF_NAME}"
          $v = $tag.TrimStart("v")
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "version=$v" >> $env:GITHUB_OUTPUT

      # ---------- BUILD MAIN ----------
      - name: Build UltimateDownloader.exe
        shell: pwsh
        run: |
          pyinstaller --noconfirm --onefile --noconsole --name UltimateDownloader main.py

      # ---------- BUILD UPDATER ----------
      - name: Build UltimateDownloaderUpdater.exe
        shell: pwsh
        run: |
          if (Test-Path ".\updater\updater.py") {
            pyinstaller --noconfirm --onefile --noconsole --name UltimateDownloaderUpdater updater\updater.py
          } else {
            pyinstaller --noconfirm --onefile --noconsole --name UltimateDownloaderUpdater updater.py
          }

      # ---------- PREPARE DIST ----------
      - name: Prepare dist for Inno
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path ".\dist"

          Copy-Item ".\dist\UltimateDownloader.exe" ".\dist\UltimateDownloader.exe" -Force
          Copy-Item ".\dist\UltimateDownloaderUpdater.exe" ".\dist\UltimateDownloaderUpdater.exe" -Force

      # ---------- COMPILE INSTALLER ----------
      - name: Compile installer
        shell: pwsh
        run: |
          iscc installer.iss

      # ---------- FIND SETUP ----------
      - name: Locate Setup
        id: setup
        shell: pwsh
        run: |
          $setup = Get-ChildItem -Recurse -Filter "*.exe" |
            Where-Object { $_.FullName -match "installer_output" -or $_.Name -match "Setup" } |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 1

          if (-not $setup) { throw "Setup.exe not found" }

          echo "path=$($setup.FullName)" >> $env:GITHUB_OUTPUT
          echo "name=$($setup.Name)" >> $env:GITHUB_OUTPUT

      - name: Compute SHA256
        id: sha
        shell: pwsh
        run: |
          $hash = (Get-FileHash -Algorithm SHA256 "${{ steps.setup.outputs.path }}").Hash.ToLower()
          echo "sha256=$hash" >> $env:GITHUB_OUTPUT

      - name: Generate latest.json
        shell: pwsh
        run: |
          $ver = "${{ steps.ver.outputs.version }}"
          $tag = "${{ steps.ver.outputs.tag }}"
          $setupName = "${{ steps.setup.outputs.name }}"
          $sha = "${{ steps.sha.outputs.sha256 }}"
          $repo = "${env:GITHUB_REPOSITORY}"

          $setupUrl = "https://github.com/$repo/releases/download/$tag/$setupName"

          $obj = @{
            version   = $ver
            setup_url = $setupUrl
            sha256    = $sha
          }

          $json = $obj | ConvertTo-Json -Depth 3
          $json | Out-File -Encoding utf8 ".\latest.json"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: ${{ steps.ver.outputs.tag }}
          files: |
            ${{ steps.setup.outputs.path }}
            latest.json