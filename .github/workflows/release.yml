name: Build & Release (Windows)

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-release:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path "requirements.txt") {
            pip install -r requirements.txt
          }
          pip install pyinstaller

      # ----------------------------
      # Build app exe
      # ----------------------------
      - name: Build UltimateDownloader.exe (PyInstaller)
        shell: pwsh
        run: |
          if (Test-Path "main.spec") {
            pyinstaller main.spec --noconfirm
          } else {
            pyinstaller .\main.py --onefile --windowed --name UltimateDownloader --noconfirm
          }
          if (!(Test-Path "dist\UltimateDownloader.exe")) {
            throw "dist\UltimateDownloader.exe not found after build"
          }

      # ----------------------------
      # Build updater exe
      # ----------------------------
      - name: Build UltimateDownloaderUpdater.exe (PyInstaller)
        shell: pwsh
        run: |
          if (Test-Path "UltimateDownloaderUpdater.spec") {
            pyinstaller UltimateDownloaderUpdater.spec --noconfirm
          } elseif (Test-Path "updater.spec") {
            pyinstaller updater.spec --noconfirm
          } else {
            pyinstaller .\updater\updater.py --onefile --windowed --name UltimateDownloaderUpdater --noconfirm
          }
          if (!(Test-Path "dist\UltimateDownloaderUpdater.exe")) {
            throw "dist\UltimateDownloaderUpdater.exe not found after build"
          }

      # ----------------------------
      # Install Inno Setup (via Chocolatey) if missing
      # ----------------------------
      - name: Ensure Inno Setup (iscc.exe)
        shell: pwsh
        run: |
          $iscc = Get-Command "iscc.exe" -ErrorAction SilentlyContinue
          if (-not $iscc) {
            choco install innosetup -y
          }
          iscc.exe /?

      # ----------------------------
      # Compile installer.iss
      # ----------------------------
      - name: Compile installer.iss (Inno)
        shell: pwsh
        run: |
          if (!(Test-Path "installer.iss")) { throw "installer.iss not found" }
          iscc.exe installer.iss

      # ----------------------------
      # Detect version from tag and setup exe name
      # ----------------------------
      - name: Detect installer output
        id: detect
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"      # v1.0.3
          $ver = $tag.TrimStart("v")           # 1.0.3

          # Inno outputs to installer_output by your script
          if (!(Test-Path "installer_output")) { throw "installer_output folder not found" }

          $setup = Get-ChildItem -Path "installer_output" -Filter "*_Setup_$ver*.exe" | Select-Object -First 1
          if (-not $setup) {
            # fallback: any exe with version inside
            $setup = Get-ChildItem -Path "installer_output" -Filter "*.exe" | Where-Object { $_.Name -match $ver } | Select-Object -First 1
          }
          if (-not $setup) { throw "Setup exe for version $ver not found in installer_output" }

          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "ver=$ver" >> $env:GITHUB_OUTPUT
          echo "setup_path=$($setup.FullName)" >> $env:GITHUB_OUTPUT
          echo "setup_name=$($setup.Name)" >> $env:GITHUB_OUTPUT

      # ----------------------------
      # Compute SHA256 for setup
      # ----------------------------
      - name: Compute SHA256
        id: sha
        shell: pwsh
        run: |
          $p = "${{ steps.detect.outputs.setup_path }}"
          $h = (Get-FileHash $p -Algorithm SHA256).Hash.ToLower()
          echo "sha256=$h" >> $env:GITHUB_OUTPUT

      # ----------------------------
      # Create GitHub Release + upload setup
      # ----------------------------
      - name: Create Release (upload setup)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.detect.outputs.tag }}
          name: ${{ steps.detect.outputs.tag }}
          files: |
            ${{ steps.detect.outputs.setup_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ----------------------------
      # Update latest.json in main
      # ----------------------------
      - name: Update latest.json (commit to main)
        shell: pwsh
        run: |
          $tag = "${{ steps.detect.outputs.tag }}"
          $ver = "${{ steps.detect.outputs.ver }}"
          $setupName = "${{ steps.detect.outputs.setup_name }}"
          $sha = "${{ steps.sha.outputs.sha256 }}"

          $setupUrl = "https://github.com/${{ github.repository }}/releases/download/$tag/$setupName"

          $obj = @{
            version = $ver
            setup_url = $setupUrl
            sha256 = $sha
          }

          $json = $obj | ConvertTo-Json -Depth 5
          Set-Content -Path "latest.json" -Value $json -Encoding UTF8

          git config user.name "github-actions"
          git config user.email "actions@users.noreply.github.com"

          git add latest.json
          git commit -m "Update latest.json to $ver" || exit 0
          git push origin HEAD:main